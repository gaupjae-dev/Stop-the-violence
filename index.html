<!DOCTYPE html>
<html>
<head>
    <title>3D Battle - Win Streak Edition</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Arial Black', sans-serif; background-color: #111; }
        
        /* Lobby Overlay */
        #lobby-overlay {
            position: absolute; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a2e 0%, #0f0f1a 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
        }
        #lobby-title { color: #ffd600; font-size: 70px; text-shadow: 4px 4px #000; margin-bottom: 10px; }
        #streak-display { color: #fff; font-size: 24px; margin-bottom: 30px; }
        .btn {
            padding: 20px 60px; font-size: 30px; cursor: pointer;
            background: #ffd600; border: none; border-radius: 50px;
            font-family: 'Arial Black', sans-serif; transition: 0.2s;
        }
        .btn:hover { transform: scale(1.1); background: #fff; }

        /* In-Game UI */
        #game-ui { display: none; }
        #stats { 
            position: absolute; top: 10px; left: 10px; 
            color: white; background: rgba(0,0,0,0.6); padding: 15px; border-radius: 8px; 
        }
        #lobby-button {
            position: absolute; top: 10px; right: 10px;
            padding: 10px 20px; background: #444; color: white;
            border: 2px solid #fff; border-radius: 5px; cursor: pointer;
            display: none; z-index: 110;
        }
        #eliminated { 
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%);
            color: #ffd600; font-size: 60px; text-shadow: 4px 4px #000;
            display: none; pointer-events: none;
        }
        #inventory { 
            position: absolute; bottom: 20px; right: 20px; width: 90px; height: 90px; 
            background: rgba(0,0,0,0.8); border: 4px solid #555; 
            display: flex; align-items: center; justify-content: center; 
            color: white; border-radius: 12px; font-size: 14px;
        }
        #crosshair { 
            position: absolute; top: 50%; left: 50%; width: 10px; height: 10px; 
            border: 2px solid white; border-radius: 50%; transform: translate(-50%, -50%); 
        }
    </style>
</head>
<body>

    <div id="lobby-overlay">
        <div id="lobby-title">BATTLE SIM</div>
        <div id="streak-display">WIN STREAK: <span id="streak-val">0</span></div>
        <button class="btn" onclick="startGame()">PLAY</button>
    </div>

    <div id="game-ui">
        <div id="stats">
            ENEMY: <span id="ai-hp" style="color: #ff4444;">100</span> HP<br>
            YOU: <span id="player-hp" style="color: #44ff44;">100</span> HP<br>
            STREAK: <span id="game-streak-val" style="color: #ffd600;">0</span>
        </div>
        <button id="lobby-button" onclick="goToLobby()">BACK TO LOBBY</button>
        <div id="eliminated">ELIMINATED</div>
        <div id="crosshair"></div>
        <div id="inventory">EMPTY</div>
    </div>
    
    <script type="module">
        import * as THREE from 'https://cdn.skypack.dev/three@0.136.0';

        let scene, camera, renderer, player, ai, pickupGun;
        let playerHP = 100, aiHP = 100, hasGun = false, inGame = false;
        let bullets = [], keys = {}, aiLastShot = 0, velocityY = 0, isGrounded = true;
        
        // Load Streak from local storage
        let winStreak = parseInt(localStorage.getItem('battleWinStreak')) || 0;
        document.getElementById('streak-val').innerText = winStreak;
        document.getElementById('game-streak-val').innerText = winStreak;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            const light = new THREE.AmbientLight(0xffffff, 0.6); scene.add(light);
            const sun = new THREE.DirectionalLight(0xffffff, 1); sun.position.set(5, 10, 7.5); scene.add(sun);

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x2e7d32 }));
            ground.rotation.x = -Math.PI / 2; scene.add(ground);

            const wall = new THREE.Mesh(new THREE.BoxGeometry(10, 5, 1), new THREE.MeshStandardMaterial({ color: 0x8b0000 }));
            wall.position.set(0, 2.5, -10); scene.add(wall);

            player = createCharacter(0x1976d2); scene.add(player);
            ai = createCharacter(0xcc0000); ai.position.set(0, 0, -20); scene.add(ai);

            pickupGun = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 1), new THREE.MeshStandardMaterial({ color: 0xffd600 }));
            pickupGun.position.set(0, 0.5, -7); scene.add(pickupGun);

            animate(0);
        }

        function createCharacter(color) {
            const group = new THREE.Group();
            const torso = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1, 0.5), new THREE.MeshStandardMaterial({ color: color }));
            torso.position.y = 1.5; group.add(torso);
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), new THREE.MeshStandardMaterial({ color: 0xffdbac }));
            head.position.y = 2.3; group.add(head);
            return group;
        }

        window.startGame = function() {
            playerHP = 100; aiHP = 100; hasGun = false;
            document.getElementById('player-hp').innerText = "100";
            document.getElementById('ai-hp').innerText = "100";
            document.getElementById('inventory').innerText = "EMPTY";
            document.getElementById('eliminated').style.display = 'none';
            document.getElementById('lobby-button').style.display = 'none';
            
            player.position.set(0,0,0);
            ai.position.set(0,0,-20);
            if (!scene.children.includes(ai)) scene.add(ai);
            if (!scene.children.includes(pickupGun)) scene.add(pickupGun);
            
            // Remove launcher if held
            for(let i = player.children.length - 1; i >= 0; i--) {
                const obj = player.children[i];
                if(obj.type === "Mesh" && obj.geometry.type === "BoxGeometry" && obj.position.x > 0) player.remove(obj);
            }

            document.getElementById('lobby-overlay').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            inGame = true;
        }

        window.goToLobby = function() {
            document.getElementById('lobby-overlay').style.display = 'flex';
            document.getElementById('game-ui').style.display = 'none';
            inGame = false;
            // Clean up old bullets
            bullets.forEach(b => scene.remove(b.mesh));
            bullets = [];
        }

        function updateStreak(win) {
            if (win) {
                winStreak++;
            } else {
                winStreak = 0;
            }
            localStorage.setItem('battleWinStreak', winStreak);
            document.getElementById('streak-val').innerText = winStreak;
            document.getElementById('game-streak-val').innerText = winStreak;
        }

        window.addEventListener('keydown', (e) => keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', (e) => keys[e.key.toLowerCase()] = false);
        window.addEventListener('mousedown', () => {
            if (inGame && hasGun && playerHP > 0) fireBullet(player, new THREE.Vector3(0,0,-1), 'player');
        });

        function fireBullet(owner, dir, side) {
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.15), new THREE.MeshBasicMaterial({ color: side === 'player' ? 0xffff00 : 0xff0000 }));
            b.position.copy(owner.position).y += 1.8;
            scene.add(b);
            bullets.push({ mesh: b, dir: dir, side: side });
        }

        function animate(t) {
            requestAnimationFrame(animate);
            if (!inGame) return;

            if (playerHP > 0) {
                if (keys.w) player.position.z -= 0.15; if (keys.s) player.position.z += 0.15;
                if (keys.a) player.position.x -= 0.15; if (keys.d) player.position.x += 0.15;
                if (keys[' '] && isGrounded) { velocityY = 0.25; isGrounded = false; }
                velocityY -= 0.012; player.position.y += velocityY;
                if (player.position.y <= 0) { player.position.y = 0; velocityY = 0; isGrounded = true; }

                if (keys.e && player.position.distanceTo(pickupGun.position) < 2 && !hasGun) {
                    hasGun = true; scene.remove(pickupGun);
                    document.getElementById('inventory').innerText = "LAUNCHER";
                    const g = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.2, 0.8), new THREE.MeshStandardMaterial({ color: 0xffd600 }));
                    g.position.set(0.6, 1.5, -0.4); player.add(g);
                }
            }

            if (aiHP > 0 && playerHP > 0) {
                ai.lookAt(player.position);
                if (t - aiLastShot > 1800) {
                    const d = new THREE.Vector3().subVectors(player.position, ai.position).normalize();
                    fireBullet(ai, d, 'ai'); aiLastShot = t;
                }
            }

            bullets.forEach((b, i) => {
                b.mesh.position.addScaledVector(b.dir, 0.5);
                
                if (b.side === 'player' && aiHP > 0) {
                    const head = new THREE.Vector3(ai.position.x, ai.position.y + 2.3, ai.position.z);
                    const body = new THREE.Vector3(ai.position.x, ai.position.y + 1.5, ai.position.z);
                    if (b.mesh.position.distanceTo(head) < 0.6) {
                        aiHP -= 35; scene.remove(b.mesh); bullets.splice(i, 1);
                    } else if (b.mesh.position.distanceTo(body) < 0.8) {
                        aiHP -= 19; scene.remove(b.mesh); bullets.splice(i, 1);
                    }
                    document.getElementById('ai-hp').innerText = Math.max(0, aiHP);
                    if (aiHP <= 0) { 
                        scene.remove(ai); 
                        document.getElementById('eliminated').style.display = 'block'; 
                        document.getElementById('lobby-button').style.display = 'block';
                        updateStreak(true);
                    }
                }
                
                if (b.side === 'ai' && playerHP > 0) {
                    if (b.mesh.position.distanceTo(new THREE.Vector3(player.position.x, player.position.y + 1.5, player.position.z)) < 0.8) {
                        playerHP -= 10; document.getElementById('player-hp').innerText = Math.max(0, playerHP);
                        scene.remove(b.mesh); bullets.splice(i, 1);
                        if (playerHP <= 0) {
                            document.getElementById('lobby-button').style.display = 'block';
                            updateStreak(false);
                        }
                    }
                }
            });

            camera.position.set(player.position.x, player.position.y + 6, player.position.z + 12);
            camera.lookAt(player.position.x, player.position.y + 1, player.position.z);
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
